<?php
/*+***********************************************************************************
 * The contents of this file are subject to the vtiger CRM Public License Version 1.0
 * ("License"); You may not use this file except in compliance with the License
 * The Original Code is:  vtiger CRM Open Source
 * The Initial Developer of the Original Code is vtiger.
 * Portions created by vtiger are Copyright (C) vtiger.
 * All Rights Reserved.
 * Contributor(s): JoForce.com
 *************************************************************************************/

class Head_Detail_View extends Head_Index_View {
	protected $record = false;
	protected $isAjaxEnabled = null;

	function __construct() {
		parent::__construct();
		$this->exposeMethod('showDetailViewByMode');
		$this->exposeMethod('showModuleDetailView');
		$this->exposeMethod('showModuleSummaryView');
		$this->exposeMethod('showModuleBasicView');
		$this->exposeMethod('showHistory');
		$this->exposeMethod('showRecentActivities');
		$this->exposeMethod('showRecentComments');
		$this->exposeMethod('showRelatedList');
		$this->exposeMethod('showChildComments');
		$this->exposeMethod('getActivities');
		$this->exposeMethod('showRelatedRecords');
	}

	function checkPermission(Head_Request $request) {
		$moduleName = $request->getModule();
		$recordId = $request->get('record');

		$recordPermission = Users_Privileges_Model::isPermitted($moduleName, 'DetailView', $recordId);
		if(!$recordPermission) {
			throw new AppException(vtranslate('LBL_PERMISSION_DENIED'));
		}

		if ($recordId) {
			$recordEntityName = getSalesEntityType($recordId);
			if ($recordEntityName !== $moduleName) {
				throw new AppException(vtranslate('LBL_PERMISSION_DENIED'));
			}
		}
		return true;
	}

	function preProcess(Head_Request $request, $display=true) {
		global $current_user,$module_table,$module_table_id;
		parent::preProcess($request, false);

		$recordId = $request->get('record');
		$moduleName = $request->getModule();
		if($moduleName == 'Contacts'){
                   $module_table = 'jo_contactdetails';
                   $module_table_id = 'contactid'; 
		}
                elseif($moduleName == 'Accounts'){
                    $module_table = 'jo_account';
		    $module_table_id = 'accountid'; 
                }
                elseif($moduleName == 'Potentials'){
        	    $module_table = 'jo_potential';
		    $module_table_id = 'potentialid'; 
                }
                elseif($moduleName == 'Products'){
        	    $module_table = 'jo_products';
                    $module_table_id = 'productid'; 
                }
	        $pipeline_model = new Settings_Pipeline_Module_Model();
        	$pipeine_modules = $pipeline_model->getPipelineEnabledModules();
	        $kanban_view = (in_array($moduleName, $pipeine_modules)) ? true : false;

		if(!$this->record){
			$this->record = Head_DetailView_Model::getInstance($moduleName, $recordId);
		}
		$recordModel = $this->record->getRecord();
		$recordStrucure = Head_RecordStructure_Model::getInstanceFromRecordModel($recordModel, Head_RecordStructure_Model::RECORD_STRUCTURE_MODE_DETAIL);
		$summaryInfo = array();
		// Take first block information as summary information
		$stucturedValues = $recordStrucure->getStructure();
		foreach($stucturedValues as $blockLabel=>$fieldList) {
			$summaryInfo[$blockLabel] = $fieldList;
			break;
		}

		$detailViewLinkParams = array('MODULE'=>$moduleName,'RECORD'=>$recordId);

		$detailViewLinks = $this->record->getDetailViewLinks($detailViewLinkParams);

		 
		  foreach($detailViewLinks['DETAILVIEWRELATED'] as $values)
		  {
			  
		 	if($values->linklabel!='ModComments'  && $values->linklabel!='Emails' && $values->linklabel!='Documents'){
				if($values->linklabel=='Activities'){
					$values->linklabel='Calendar';
				}	
		 		if($values->linklabel=='Product Bundles'){
		 				break;
		 		}
				if($values->linklabel==='CALENDAR')
				{
					$values->linklabel='Calendar';
				}
				
				if($values->linklabel=='Products'){
						$wprice='unit_price';
				}
				elseif($values->linklabel=='Services'){
						$wprice='unit_price';
				}
				elseif($values->linklabel=='Potentials'){
						$wprice='amount';
				}
				else{
						$wprice='';
				}
				
		 		if($values->linklabel=='Invoice'|| $values->linklabel=='Quotes'|| $values->linklabel=='SalesOrder'|| $values->linklabel == 'Sales Order' || $values->linklabel=='PurchaseOrder' || $values->linklabel == 'Purchase Order'){
					global $adb;
					if($values->linklabel=='Invoice'){
						$key='Invoice';
						$wid='invoiceid';
						$wtable='jo_invoice';
					}
					if($values->linklabel=='Quotes'){
						$key='Quotes';
						$wid='quoteid';
						$wtable= 'jo_quotes';
					}
					if($values->linklabel=='SalesOrder' || $values->linklabel=='Sales Order'){
						$values->linklabel ='SalesOrder';
						$key='SalesOrder';
						$wid='salesorderid';
						$wtable='jo_salesorder';
					}
					if($values->linklabel=='PurchaseOrder' || $values->linklabel=='Purchase Order'){
						$values->linklabel ='PurchaseOrder';
						$key='PurchaseOrder';
						$wid='purchaseorderid';
						$wtable='jo_purchaseorder';
					}	
					
		 		 	if($moduleName === 'Products'){
		 		 		$query = $adb->pquery("select total from {$wtable} INNER join jo_inventoryproductrel  ON jo_inventoryproductrel.id = {$wtable}.{$wid} INNER JOIN jo_products ON jo_products.productid = jo_inventoryproductrel.productid  LEFT JOIN {$wtable}cf ON {$wtable}cf.{$wid} = {$wtable}.{$wid} LEFT JOIN jo_pobillads ON jo_pobillads.pobilladdressid = {$wtable}.{$wid} LEFT JOIN jo_poshipads ON jo_poshipads.poshipaddressid = {$wtable}.{$wid}  WHERE jo_products.productid = ?", array($recordId));
		 		 	}
		 		 	elseif($moduleName === 'Services'){
		 		 		$query = $adb->pquery("select total FROM {$wtable} INNER JOIN jo_inventoryproductrel ON jo_inventoryproductrel.id = {$wtable}.{$wid} INNER JOIN jo_service ON jo_service.serviceid = jo_inventoryproductrel.productid LEFT JOIN  {$wtable}cf ON {$wtable}cf.{$wid} = {$wtable}.{$wid} LEFT JOIN jo_pobillads ON jo_pobillads.pobilladdressid = {$wtable}.{$wid} LEFT JOIN jo_poshipads ON jo_poshipads.poshipaddressid = {$wtable}.{$wid}  WHERE jo_service.serviceid = ?", array($recordId));
		 		 	}
		 		 	else{
		 		 	$query = $adb->pquery("select total from {$wtable},{$module_table} where {$wtable}.{$module_table_id} = {$module_table}.{$module_table_id} and {$wtable}.{$module_table_id} = ? ", array($recordId));
					}
						   
				 	if($adb->num_rows($query) > 0){
						$count=0;
				 	 	while($result = $adb->fetch_array($query)){
							$count += $result['total'];
					 	}
					 	$getRelatedModules = '$'.$count;
					}
					else{
						$getRelatedModules = 0;
					}
					
		 		}
				else {

						$getRelatedModules = getRelatedRecordSumValue($recordId, $request->getModule(),$values->linklabel,$wprice);	
				}
				
				if(count($total)<9){
					if($request->getModule() =='Leads'){
						if($values->linklabel !='Products' && $values->linklabel !='Services' ){
						$total[$values->linklabel] = $getRelatedModules? $getRelatedModules : 0;
						}
					
				}
				elseif($request->getModule() =='Accounts'){
					if($values->linklabel !='Products' &&  $values->linklabel !='Services' && $values->linklabel !='HelpDesk' && $values->linklabel !='PBXManager' &&  $values->linklabel !='Campaigns'){
						$total[$values->linklabel] = $getRelatedModules? $getRelatedModules : 0;
					}
				}
				elseif($request->getModule() =='Contacts'){
					if($values->linklabel !='Products' &&  $values->linklabel !='Services' && $values->linklabel !='HelpDesk' && $values->linklabel !='PBXManager' &&  $values->linklabel !='Vendors' &&  $values->linklabel !='Campaigns'){
						$total[$values->linklabel] = $getRelatedModules? $getRelatedModules : 0;
					}
				}
				elseif($request->getModule() =='Potentials'){
					if($values->linklabel !='Products' &&  $values->linklabel !='Services' && $values->linklabel !='PBXManager' &&  $values->linklabel !='Vendors'){
						$total[$values->linklabel] = $getRelatedModules? $getRelatedModules : 0;
					}
				}
				elseif($request->getModule() =='Products'){
					if($values->linklabel !='Products' && $values->linklabel !='HelpDesk' &&  $values->linklabel !='Services' &&  $values->linklabel !='Leads' &&  $values->linklabel !='Accounts' && $values->linklabel !='Contacts' && $values->linklabel !='PBXManager' && $values->linklabel !='Potentials' &&  $values->linklabel !='PriceBooks'){
						$total[$values->linklabel] = $getRelatedModules? $getRelatedModules : 0;
					}
				}
				elseif($request->getModule() =='Services'){
					if($values->linklabel !='Products'  &&  $values->linklabel !='Services' &&  $values->linklabel !='Leads' &&  $values->linklabel !='Accounts'  && $values->linklabel !='PBXManager' && $values->linklabel !='Potentials' &&  $values->linklabel !='PriceBooks' && $values->linklabel !='Contacts'){
						$total[$values->linklabel] = $getRelatedModules? $getRelatedModules : 0;
					}
				}
				elseif($request->getModule() =='HelpDesk'){
					if( $values->linklabel !='Services' ){
						$total[$values->linklabel] = $getRelatedModules? $getRelatedModules : 0;
						}
				}
					
				else{
						$total[$values->linklabel] = $getRelatedModules? $getRelatedModules : 0;
					}
				}
				

		 	
			}
			
		  }
		$navigationInfo = ListViewSession::getListViewNavigation($recordId);

		$viewer = $this->getViewer($request);
		$viewer->assign('kanban_view_enabled' ,$kanban_view);
		$viewer->assign('MASQUERADEUSERMODULE', $masquerade_user_module);
		$viewer->assign('RECORD', $recordModel);
		$viewer->assign('NAVIGATION', $navigationInfo);
		  $viewer->assign('TOTAL', $total);
		  $viewer->assign('RECORD_STRUCTURE', $stucturedValues); 
		  

		//Intially make the prev and next records as null
		$prevRecordId = null;
		$nextRecordId = null;
		$found = false;
		if ($navigationInfo) {
			foreach($navigationInfo as $page=>$pageInfo) {
				foreach($pageInfo as $index=>$record) {
					//If record found then next record in the interation
					//will be next record
					if($found) {
						$nextRecordId = $record;
						break;
					}
					if($record == $recordId) {
						$found = true;
					}
					//If record not found then we are assiging previousRecordId
					//assuming next record will get matched
					if(!$found) {
						$prevRecordId = $record;
					}
				}
				//if record is found and next record is not calculated we need to perform iteration
				if($found && !empty($nextRecordId)) {
					break;
				}
			}
		}

		$moduleModel = Head_Module_Model::getInstance($moduleName);
		if(!empty($prevRecordId)) {
			$viewer->assign('PREVIOUS_RECORD_URL', $moduleModel->getDetailViewUrl($prevRecordId));
		}
		if(!empty($nextRecordId)) {
			$viewer->assign('NEXT_RECORD_URL', $moduleModel->getDetailViewUrl($nextRecordId));
		}

		$viewer->assign('MODULE_MODEL', $this->record->getModule());
		$viewer->assign('DETAILVIEW_LINKS', $detailViewLinks);

		$viewer->assign('IS_EDITABLE', $this->record->getRecord()->isEditable($moduleName));
		$viewer->assign('IS_DELETABLE', $this->record->getRecord()->isDeletable($moduleName));

		$linkParams = array('MODULE'=>$moduleName, 'ACTION'=>$request->get('view'));
		$linkModels = $this->record->getSideBarLinks($linkParams);
		$viewer->assign('QUICK_LINKS', $linkModels);
		$viewer->assign('MODULE_NAME', $moduleName);

		$currentUserModel = Users_Record_Model::getCurrentUserModel();
		$viewer->assign('DEFAULT_RECORD_VIEW', $currentUserModel->get('default_record_view'));

		$picklistDependencyDatasource = Head_DependencyPicklist::getPicklistDependencyDatasource($moduleName);
		$viewer->assign('PICKIST_DEPENDENCY_DATASOURCE', Head_Functions::jsonEncode($picklistDependencyDatasource));

		$tagsList = Head_Tag_Model::getAllAccessible($currentUserModel->getId(), $moduleName, $recordId);
		$allUserTags = Head_Tag_Model::getAllUserTags($currentUserModel->getId());
		$viewer->assign('TAGS_LIST', $tagsList);
		$viewer->assign('ALL_USER_TAGS', $allUserTags);

		$selectedTabLabel = $request->get('tab_label');
		$relationId = $request->get('relationId');

		if(empty($selectedTabLabel)) {
			if($currentUserModel->get('default_record_view') === 'Detail') {
				$selectedTabLabel = vtranslate('SINGLE_'.$moduleName, $moduleName).' '. vtranslate('LBL_DETAILS', $moduleName);
			} else{
				if($moduleModel->isSummaryViewSupported()) {
					$selectedTabLabel = vtranslate('SINGLE_'.$moduleName, $moduleName).' '. vtranslate('LBL_SUMMARY', $moduleName);
				} else {
					$selectedTabLabel = vtranslate('SINGLE_'.$moduleName, $moduleName).' '. vtranslate('LBL_DETAILS', $moduleName);
				}
			}
		}

		$viewer->assign('SELECTED_TAB_LABEL', $selectedTabLabel);
		$viewer->assign('SELECTED_RELATION_ID',$relationId);

		//Head7 - TO show custom view name in Module Header
		$viewer->assign('CUSTOM_VIEWS', CustomView_Record_Model::getAllByGroup($moduleName));
		/*masquerade for contacts*/
		$query = getMasqueradeUserRecordDetails();
		$result = $query['support_end_date'];
		$viewer->assign('RESULT', $result);
		/*masquerade for contacts*/
		$viewer->assign('IS_AJAX_ENABLED', $this->isAjaxEnabled($recordModel));

                $recordStrucure = Head_RecordStructure_Model::getInstanceFromRecordModel($recordModel, Head_RecordStructure_Model::RECORD_STRUCTURE_MODE_SUMMARY);

                $viewer->assign('BLOCK_LIST', $moduleModel->getBlocks());
                $viewer->assign('USER_MODEL', Users_Record_Model::getCurrentUserModel());

                $viewer->assign('MODULE_NAME', $moduleName);
                $viewer->assign('SUMMARY_RECORD_STRUCTURE', $recordStrucure->getStructure());
				$SUMMARY_RECORD_STRUCTURE = $recordStrucure->getStructure();
                $viewer->assign('CURRENT_USER_MODEL', Users_Record_Model::getCurrentUserModel());
                $pagingModel = new Head_Paging_Model();
                $viewer->assign('PAGING_MODEL', $pagingModel);

                $picklistDependencyDatasource = Head_DependencyPicklist::getPicklistDependencyDatasource($moduleName);
                $viewer->assign('PICKIST_DEPENDENCY_DATASOURCE', Head_Functions::jsonEncode($picklistDependencyDatasource));

		if(in_array($moduleName,array('Contacts','Accounts','Leads', 'Vendors'))) {
			include_once ('modules/Google/helpers/Map.php');
			$address_string = Google_Map_Helper::getAddressString($recordId, $moduleName);
			$viewer->assign('ADDRESS_STRING', $address_string);
		}

		$relatedResult = new Head_Module_Model();
		$hj=$relatedResult->getRelations();
		if($display) {
			$this->preProcessDisplay($request);
		}
	}

	function preProcessTplName(Head_Request $request) {
		return 'DetailViewPreProcess.tpl';
	}

	function process(Head_Request $request) {
		$mode = $request->getMode();
		if(!empty($mode)) {
			echo $this->invokeExposedMethod($mode, $request);
			return;
		}

		$currentUserModel = Users_Record_Model::getCurrentUserModel();

		if ($currentUserModel->get('default_record_view') === 'Summary') {
			echo $this->showModuleBasicView($request);
		} else {
			echo $this->showModuleDetailView($request);
		}
	}

	public function postProcess(Head_Request $request) {
		$recordId = $request->get('record');
		$moduleName = $request->getModule();
		if($moduleName=="Calendar"){
			$recordModel = Head_Record_Model::getInstanceById($recordId);
			$activityType = $recordModel->getType();
			if($activityType=="Events"){
				$moduleName="Events";
			}
		}
		$currentUserModel = Users_Record_Model::getCurrentUserModel();
		$moduleModel = Head_Module_Model::getInstance($moduleName);
		if(!$this->record){
			$this->record = Head_DetailView_Model::getInstance($moduleName, $recordId);
		}
		$detailViewLinkParams = array('MODULE'=>$moduleName,'RECORD'=>$recordId);
		$detailViewLinks = $this->record->getDetailViewLinks($detailViewLinkParams);

		$selectedTabLabel = $request->get('tab_label');
		$relationId = $request->get('relationId');

		if(empty($selectedTabLabel)) {
			if($currentUserModel->get('default_record_view') === 'Detail') {
				$selectedTabLabel = vtranslate('SINGLE_'.$moduleName, $moduleName).' '. vtranslate('LBL_DETAILS', $moduleName);
			} else{
				if($moduleModel->isSummaryViewSupported()) {
					$selectedTabLabel = vtranslate('SINGLE_'.$moduleName, $moduleName).' '. vtranslate('LBL_SUMMARY', $moduleName);
				} else {
					$selectedTabLabel = vtranslate('SINGLE_'.$moduleName, $moduleName).' '. vtranslate('LBL_DETAILS', $moduleName);
				}
			}
		}

		$viewer = $this->getViewer($request);

		$viewer->assign('SELECTED_TAB_LABEL', $selectedTabLabel);
		$viewer->assign('SELECTED_RELATION_ID',$relationId);
		$viewer->assign('MODULE_MODEL', $this->record->getModule());
		$viewer->assign('DETAILVIEW_LINKS', $detailViewLinks);

		$viewer->view('DetailViewPostProcess.tpl', $moduleName);

		parent::postProcess($request);
	}


	public function getHeaderScripts(Head_Request $request) {
		$headerScriptInstances = parent::getHeaderScripts($request);
		$moduleName = $request->getModule();

		$jsFileNames = array(
			'modules.Head.resources.Detail',
			"modules.$moduleName.resources.Detail",
			'modules.Head.resources.RelatedList',
			"modules.$moduleName.resources.RelatedList",
			'libraries.jquery.jquery_windowmsg',
			"libraries.jquery.ckeditor.ckeditor",
			"libraries.jquery.ckeditor.adapters.jquery",
			"modules.Emails.resources.MassEdit",
			"modules.Head.resources.CkEditor",
			"~/libraries/jquery/twitter-text-js/twitter-text.js",
			"libraries.jquery.multiplefileupload.jquery_MultiFile",
			'~/libraries/jquery/bootstrapswitch/js/bootstrap-switch.min.js',
			'~/libraries/jquery.bxslider/jquery.bxslider.min.js',
			"~layouts/lib/jquery/Lightweight-jQuery-In-page-Filtering-Plugin-instaFilta/instafilta.js",
			'modules.Head.resources.Tag',
			'modules.Google.resources.Map'
		);

		$jsScriptInstances = $this->checkAndConvertJsScripts($jsFileNames);
		$headerScriptInstances = array_merge($headerScriptInstances, $jsScriptInstances);
		return $headerScriptInstances;
	}

	function showDetailViewByMode($request) {
		$requestMode = $request->get('requestMode');
		if($requestMode == 'full') {
			return $this->showModuleDetailView($request);
		}
		return $this->showModuleBasicView($request);
	}

	/**
	 * Function shows the entire detail for the record
	 * @param Head_Request $request
	 * @return <type>
	 */
	function showModuleDetailView(Head_Request $request) {
		$recordId = $request->get('record');
		$moduleName = $request->getModule();

		if(!$this->record){
		$this->record = Head_DetailView_Model::getInstance($moduleName, $recordId);
		}
		$recordModel = $this->record->getRecord();
		$recordStrucure = Head_RecordStructure_Model::getInstanceFromRecordModel($recordModel, Head_RecordStructure_Model::RECORD_STRUCTURE_MODE_DETAIL);
		$structuredValues = $recordStrucure->getStructure();

		$moduleModel = $recordModel->getModule();

		$viewer = $this->getViewer($request);
		$viewer->assign('RECORD', $recordModel);
		$viewer->assign('RECORD_STRUCTURE', $structuredValues);
		$viewer->assign('BLOCK_LIST', $moduleModel->getBlocks());
		$viewer->assign('USER_MODEL', Users_Record_Model::getCurrentUserModel());
		$viewer->assign('MODULE_NAME', $moduleName);
		$viewer->assign('IS_AJAX_ENABLED', $this->isAjaxEnabled($recordModel));
		$viewer->assign('MODULE', $moduleName);

		$picklistDependencyDatasource = Head_DependencyPicklist::getPicklistDependencyDatasource($moduleName);
		$viewer->assign('PICKIST_DEPENDENCY_DATASOURCE', Head_Functions::jsonEncode($picklistDependencyDatasource));

		if ($request->get('displayMode') == 'overlay') {
			$viewer->assign('MODULE_MODEL', $moduleModel);
			$this->setModuleInfo($request, $moduleModel);
			//$viewer->assign('SCRIPTS',$this->getOverlayHeaderScripts($request));
			$detailViewLinkParams = array('MODULE'=>$moduleName, 'RECORD'=>$recordId);
			$detailViewLinks = $this->record->getDetailViewLinks($detailViewLinkParams);
			$viewer->assign('DETAILVIEW_LINKS', $detailViewLinks);
			return $viewer->view('OverlayDetailView.tpl', $moduleName);
		} else {
			$viewer->assign('MODULE_MODEL', $moduleModel);
			return $viewer->view('DetailViewFullContents.tpl', $moduleName, true);
		}
	}
	public function getOverlayHeaderScripts(Head_Request $request){
	    global $site_URL;
		$moduleName = $request->getModule();
		$jsFileNames = array(
			$site_URL . "layouts/modules/$moduleName/resources/Detail.js",
		);
		$jsScriptInstances = $this->checkAndConvertJsScripts($jsFileNames);
		return $jsScriptInstances;	
	}

	function showModuleSummaryView($request) {
		$recordId = $request->get('record');
		$moduleName = $request->getModule();

		if(!$this->record){
			$this->record = Head_DetailView_Model::getInstance($moduleName, $recordId);
		}
		$recordModel = $this->record->getRecord();
		$recordStrucure = Head_RecordStructure_Model::getInstanceFromRecordModel($recordModel, Head_RecordStructure_Model::RECORD_STRUCTURE_MODE_SUMMARY);

		$moduleModel = $recordModel->getModule();
		$viewer = $this->getViewer($request);
		$viewer->assign('RECORD', $recordModel);
		$viewer->assign('BLOCK_LIST', $moduleModel->getBlocks());
		$viewer->assign('USER_MODEL', Users_Record_Model::getCurrentUserModel());

		$viewer->assign('MODULE_NAME', $moduleName);
		$viewer->assign('IS_AJAX_ENABLED', $this->isAjaxEnabled($recordModel));
		$viewer->assign('SUMMARY_RECORD_STRUCTURE', $recordStrucure->getStructure());
		$viewer->assign('RELATED_ACTIVITIES', $this->getActivities($request));

		$viewer->assign('CURRENT_USER_MODEL', Users_Record_Model::getCurrentUserModel());
		$pagingModel = new Head_Paging_Model();
		$viewer->assign('PAGING_MODEL', $pagingModel);

		$picklistDependencyDatasource = Head_DependencyPicklist::getPicklistDependencyDatasource($moduleName);
		$viewer->assign('PICKIST_DEPENDENCY_DATASOURCE', Head_Functions::jsonEncode($picklistDependencyDatasource));

		return $viewer->view('ModuleSummaryView.tpl', $moduleName, true);
	}

	/**
	 * Function shows basic detail for the record
	 * @param <type> $request
	 */
	function showModuleBasicView($request) {
		
		$recordId = $request->get('record');
		$moduleName = $request->getModule();
		$viewer = $this->getViewer($request);
		
		if(!$this->record){
			$this->record = Head_DetailView_Model::getInstance($moduleName, $recordId);
		}
		$recordModel = $this->record->getRecord();

		$detailViewLinkParams = array('MODULE'=>$moduleName,'RECORD'=>$recordId);
		$detailViewLinks = $this->record->getDetailViewLinks($detailViewLinkParams);
		
		$widget_arrayValues = getDetailViewSummaryWidget($moduleName);
		
		if(!empty($widget_arrayValues))
			$viewer->assign('DETAIL_SUMMARY_WIDGET', $widget_arrayValues);

		$viewer->assign('RECORD', $recordModel);
		$viewer->assign('MODULE_SUMMARY', $this->showModuleSummaryView($request));

		$viewer->assign('DETAILVIEW_LINKS', $detailViewLinks);
		$viewer->assign('USER_MODEL', Users_Record_Model::getCurrentUserModel());
		$viewer->assign('IS_AJAX_ENABLED', $this->isAjaxEnabled($recordModel));
		$viewer->assign('MODULE_NAME', $moduleName);
		$viewer->assign('MODULE_ID', getTabid($moduleName));
		$viewer->assign('RECORD_ID', $recordId);

		$recordStrucure = Head_RecordStructure_Model::getInstanceFromRecordModel($recordModel, Head_RecordStructure_Model::RECORD_STRUCTURE_MODE_DETAIL);
		$structuredValues = $recordStrucure->getStructure();

		$moduleModel = $recordModel->getModule();
		$viewer->assign('CURRENT_USER_MODEL', Users_Record_Model::getCurrentUserModel());
		$viewer->assign('RECORD_STRUCTURE', $structuredValues);
		$viewer->assign('BLOCK_LIST', $moduleModel->getBlocks());
		echo $viewer->view('DetailViewSummaryContents.tpl', $moduleName, true);
	}

	/**
	 * Funtion to show History view
	 * @param Head_Request $request
	 */
	function showHistory(Head_Request $request){
		//$moduleName = $request->getModule();
		//$viewer = $this->getViewer($request);
		//echo $viewer->view('History.tpl', $moduleName, true);
		$moduleName = $request->getModule();
                $this->_showRecentActivities($request);

                $viewer = $this->getViewer($request);
                echo $viewer->view('RecentActivities.tpl', $moduleName, true);
	}

	/**
	 * Added to support Engagements view in Head7
	 * @param Head_Request $request
	 */
	function _showRecentActivities(Head_Request $request){
		$parentRecordId = $request->get('record');
		$pageNumber = $request->get('page');
		$limit = $request->get('limit');
		$moduleName = $request->getModule();

		if(empty($pageNumber)) {
			$pageNumber = 1;
		}

		$pagingModel = new Head_Paging_Model();
		$pagingModel->set('page', $pageNumber);
		if(!empty($limit)) {
			$pagingModel->set('limit', $limit);
		}

		$recentActivities = ModTracker_Record_Model::getUpdates($parentRecordId, $pagingModel,$moduleName,"");
		$pagingModel->calculatePageRange($recentActivities);

		if($pagingModel->getCurrentPage() == ModTracker_Record_Model::getTotalRecordCount($parentRecordId)/$pagingModel->getPageLimit()) {
			$pagingModel->set('nextPageExists', false);
		}
		$recordModel = Head_Record_Model::getInstanceById($parentRecordId);
		$viewer = $this->getViewer($request);
		$viewer->assign('SOURCE',$recordModel->get('source'));
		$viewer->assign('RECENT_ACTIVITIES', $recentActivities);
		$viewer->assign('MODULE_NAME', $moduleName);
		$viewer->assign('PAGING_MODEL', $pagingModel);
		$viewer->assign('RECORD_ID',$parentRecordId);
	}

	/**
	 * Function returns recent changes made on the record
	 * @param Head_Request $request
	 */
	function showRecentActivities (Head_Request $request){
		$moduleName = $request->getModule();
		$this->_showRecentActivities($request);

		$viewer = $this->getViewer($request);
		echo $viewer->view('RecentActivities.tpl', $moduleName, true);
	}

	/**
	 * Function returns latest comments
	 * @param Head_Request $request
	 * @return <type>
	 */
	function showRecentComments(Head_Request $request) {
		$parentId = $request->get('record');
		$pageNumber = $request->get('page');
		$limit = $request->get('limit');
		$moduleName = $request->getModule();
		$currentUserModel = Users_Record_Model::getCurrentUserModel();

		if(empty($pageNumber)) {
			$pageNumber = 1;
		}

		$pagingModel = new Head_Paging_Model();
		$pagingModel->set('page', $pageNumber);
		if(!empty($limit)) {
			$pagingModel->set('limit', $limit);
		}

		if($request->get('rollup-toggle')) {
			$rollupsettings = ModComments_Module_Model::storeRollupSettingsForUser($currentUserModel, $request);
		} else {
			$rollupsettings = ModComments_Module_Model::getRollupSettingsForUser($currentUserModel, $moduleName);
		}

		if($rollupsettings['rollup_status']) {
			$parentRecordModel = Head_Record_Model::getInstanceById($parentId, $moduleName);
			$recentComments = $parentRecordModel->getRollupCommentsForModule(0, 5);
		}else {
			// $recentComments = ModComments_Record_Model::getRecentComments($parentId, $pagingModel);
			$recentComments = ModComments_Record_Model::getAllParentComments($parentId, $pagingModel);
		}

		$pagingModel->calculatePageRange($recentComments);
		if ($pagingModel->get('limit') < count($recentComments)) {
			array_pop($recentComments);
		}

		$modCommentsModel = Head_Module_Model::getInstance('ModComments');
		$fileNameFieldModel = Head_Field::getInstance("filename", $modCommentsModel);
		$fileFieldModel = Head_Field_Model::getInstanceFromFieldObject($fileNameFieldModel);

		$viewer = $this->getViewer($request);
		$viewer->assign('COMMENTS', $recentComments);
		$viewer->assign('CURRENTUSER', $currentUserModel);
		$viewer->assign('MODULE_NAME', $moduleName);
		$viewer->assign('PAGING_MODEL', $pagingModel);
		$viewer->assign('FIELD_MODEL', $fileFieldModel);
		$viewer->assign('MAX_UPLOAD_LIMIT_MB', Head_Util_Helper::getMaxUploadSize());
		$viewer->assign('MAX_UPLOAD_LIMIT_BYTES', Head_Util_Helper::getMaxUploadSizeInBytes());
		$viewer->assign('COMMENTS_MODULE_MODEL', $modCommentsModel);
		$viewer->assign('ROLLUP_STATUS', $rollupsettings['rollup_status']);
		$viewer->assign('ROLLUPID', $rollupsettings['rollupid']);
		$viewer->assign('PARENT_RECORD', $parentId);

		return $viewer->view('RecentComments.tpl', $moduleName, 'true');
	}

	/**
	 * Function returns related records
	 * @param Head_Request $request
	 * @return <type>
	 */
	function showRelatedList(Head_Request $request) {
		$moduleName = $request->getModule();
		$relatedModuleName = $request->get('relatedModule');
		$targetControllerClass = null;

		if($relatedModuleName == 'ModComments') {
			$currentUserModel = Users_Record_Model::getCurrentUserModel();
			$rollupSettings = ModComments_Module_Model::getRollupSettingsForUser($currentUserModel, $moduleName);
			$request->set('rollup_settings', $rollupSettings);
		}

		// Added to support related list view from the related module, rather than the base module.
		try {
			$targetControllerClass = Head_Loader::getComponentClassName('View', 'In'.$moduleName.'Relation', $relatedModuleName);
		}catch(AppException $e) {
			try {
				// If any module wants to have same view for all the relation, then invoke this.
				$targetControllerClass = Head_Loader::getComponentClassName('View', 'InRelation', $relatedModuleName);
			}catch(AppException $e) {
				// Default related list
				$targetControllerClass = Head_Loader::getComponentClassName('View', 'RelatedList', $moduleName);
			}
		}
		if($targetControllerClass) {
			$targetController = new $targetControllerClass();
			return $targetController->process($request);
		}
	}

	/**
	 * Function sends the child comments for a comment
	 * @param Head_Request $request
	 * @return <type>
	 */
	function showChildComments(Head_Request $request) {
		$parentCommentId = $request->get('commentid');
		$recentComment = $request->get('recentComment');
		$parentCommentModel = ModComments_Record_Model::getInstanceById($parentCommentId);
		$childComments = $parentCommentModel->getChildComments();
		$currentUserModel = Users_Record_Model::getCurrentUserModel();
		$modCommentsModel = Head_Module_Model::getInstance('ModComments');

		$viewer = $this->getViewer($request);
		$viewer->assign('PARENT_COMMENTS', $childComments);
		$viewer->assign('RECENT_COMMENT', $recentComment);
		$viewer->assign('CURRENTUSER', $currentUserModel);
		$viewer->assign('COMMENTS_MODULE_MODEL', $modCommentsModel);

		return $viewer->view('CommentsList.tpl', $moduleName, 'true');
	}

	/**
	 * Function to get Ajax is enabled or not
	 * @param Head_Record_Model record model
	 * @return <boolean> true/false
	 */
	function isAjaxEnabled($recordModel) {
		if(is_null($this->isAjaxEnabled)){
			$this->isAjaxEnabled = $recordModel->isEditable();
		}
		return $this->isAjaxEnabled;
	}

	/**
	 * Function to get activities
	 * @param Head_Request $request
	 * @return <List of activity models>
	 */
	public function getActivities(Head_Request $request) {
		return '';
	}


	/**
	 * Function returns related records based on related moduleName
	 * @param Head_Request $request
	 * @return <type>
	 */
	function showRelatedRecords(Head_Request $request) {
		$parentId = $request->get('record');
		$pageNumber = $request->get('page');
		$limit = $request->get('limit');
		$relatedModuleName = $request->get('relatedModule');
		$moduleName = $request->getModule();

		if(empty($pageNumber)) {
			$pageNumber = 1;
		}

		$pagingModel = new Head_Paging_Model();
		$pagingModel->set('page', $pageNumber);
		if(!empty($limit)) {
			$pagingModel->set('limit', $limit);
		}

		$parentRecordModel = Head_Record_Model::getInstanceById($parentId, $moduleName);
		$relationListView = Head_RelationListView_Model::getInstance($parentRecordModel, $relatedModuleName);
		$models = $relationListView->getEntries($pagingModel);
		$header = $relationListView->getHeaders();

		$viewer = $this->getViewer($request);
		$viewer->assign('PARENT_ID' , $parentId);
		$viewer->assign('PARENT_MODULE' , $moduleName);
		$viewer->assign('MODULE' , $moduleName);
		$viewer->assign('RELATED_RECORDS' , $models);
		$viewer->assign('RELATED_HEADERS', $header);
		$viewer->assign('RELATED_MODULE' , $relatedModuleName);
		$viewer->assign('PAGING_MODEL', $pagingModel);
		$viewer->assign('RELATION_OPERATOR', true);

		return $viewer->view('SummaryWidgets.tpl', $moduleName, 'true');
	}

	public function getHeaderCss(Head_Request $request) {
		$headerCssInstances = parent::getHeaderCss($request);
		$cssFileNames = array(
			'~/libraries/jquery/bootstrapswitch/css/bootstrap2/bootstrap-switch.min.css',
		);
		$cssInstances = $this->checkAndConvertCssStyles($cssFileNames);
		$headerCssInstances = array_merge($headerCssInstances, $cssInstances);
		return $headerCssInstances;
	}
	
	function detailviewSummaryWidget($request, $widget_arrayValues, $tabId)
	{

	}
}
